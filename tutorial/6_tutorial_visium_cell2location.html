<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>6: Visium Data Analysis &mdash; SpatialCells 1.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=292eb321"></script>
        <script src="../_static/doctools.js?v=9a2dae69"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="7: Working with Squidpy" href="7_tutorial_squidpy_joint_analysis.html" />
    <link rel="prev" title="5: Loading and Saving Regions" href="5_tutorial_import_export_omero.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            SpatialCells
          </a>
              <div class="version">
                1.0.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../quickstart.html">Quick Start Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../tutorials.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="0_tutorial_spatial_functions.html">0: Basic Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="1_tutorial_measurements.html">1: Spatial and Measurement Functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="2_tutorial_tumor_proliferation.html">2: Tumor Proliferation Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="3_tutorial_immune_infiltration_overlap.html">3: Immune Infiltration Overlap Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="4_tutorial_macro_micro_regions.html">4: Macro and Micro Regions Analysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="5_tutorial_import_export_omero.html">5: Loading and Saving Regions</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">6: Visium Data Analysis</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Read-data">Read data</a></li>
<li class="toctree-l3"><a class="reference internal" href="#getBoundary">getBoundary</a></li>
<li class="toctree-l3"><a class="reference internal" href="#assignPointsToRegion">assignPointsToRegion</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="7_tutorial_squidpy_joint_analysis.html">7: Working with Squidpy</a></li>
<li class="toctree-l2"><a class="reference internal" href="8_tutorial_scimap_joint_analysis.html">8: Working with SCIMAP and Scanpy</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../spatialcells.html">Functions Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">SpatialCells</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../tutorials.html">Tutorials</a></li>
      <li class="breadcrumb-item active">6: Visium Data Analysis</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/tutorial/6_tutorial_visium_cell2location.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="6:-Visium-Data-Analysis">
<h1>6: Visium Data Analysis<a class="headerlink" href="#6:-Visium-Data-Analysis" title="Link to this heading"></a></h1>
<p>Demonstrate the usage of spatialcells for deconvoluted Visium datasets (via cell2location)</p>
<div class="line-block">
<div class="line">&#64;author: Guihong Wan and Boshen Yan</div>
<div class="line">&#64;date: Feb 6 2024</div>
<div class="line">&#64;last updated: Feb 6 2024</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="kn">import</span> <span class="nn">anndata</span> <span class="k">as</span> <span class="nn">ad</span>
<span class="kn">import</span> <span class="nn">scanpy</span> <span class="k">as</span> <span class="nn">sc</span>

<span class="kn">import</span> <span class="nn">spatialcells</span> <span class="k">as</span> <span class="nn">spc</span>
</pre></div>
</div>
</div>
<section id="Read-data">
<h2>Read data<a class="headerlink" href="#Read-data" title="Link to this heading"></a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata</span> <span class="o">=</span> <span class="n">ad</span><span class="o">.</span><span class="n">read_h5ad</span><span class="p">(</span><span class="s2">&quot;../../data/sp_1.h5ad&quot;</span><span class="p">)</span>
<span class="n">adata</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
AnnData object with n_obs × n_vars = 4035 × 10217
    obs: &#39;in_tissue&#39;, &#39;array_row&#39;, &#39;array_col&#39;, &#39;sample&#39;, &#39;_indices&#39;, &#39;_scvi_batch&#39;, &#39;_scvi_labels&#39;
    var: &#39;feature_types&#39;, &#39;genome&#39;, &#39;SYMBOL&#39;, &#39;MT_gene&#39;
    uns: &#39;_scvi_manager_uuid&#39;, &#39;_scvi_uuid&#39;, &#39;mod&#39;, &#39;spatial&#39;
    obsm: &#39;MT&#39;, &#39;means_cell_abundance_w_sf&#39;, &#39;q05_cell_abundance_w_sf&#39;, &#39;q95_cell_abundance_w_sf&#39;, &#39;spatial&#39;, &#39;stds_cell_abundance_w_sf&#39;
</pre></div></div>
</div>
<p>We use 5% quantile of the posterior distribution, representing the value of cell abundance that the model has high confidence in (aka ‘at least this amount is present’).</p>
<p><a class="reference external" href="https://cell2location.readthedocs.io/en/latest/notebooks/cell2location_tutorial.html#Visualising-cell-abundance-in-spatial-coordinates">https://cell2location.readthedocs.io/en/latest/notebooks/cell2location_tutorial.html#Visualising-cell-abundance-in-spatial-coordinates</a></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;mod&#39;</span><span class="p">][</span><span class="s1">&#39;factor_names&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;q05_cell_abundance_w_sf&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">columns</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Index([&#39;in_tissue&#39;, &#39;array_row&#39;, &#39;array_col&#39;, &#39;sample&#39;, &#39;_indices&#39;,
       &#39;_scvi_batch&#39;, &#39;_scvi_labels&#39;, &#39;B_Cycling&#39;, &#39;B_GC_DZ&#39;, &#39;B_GC_LZ&#39;,
       &#39;B_GC_prePB&#39;, &#39;B_IFN&#39;, &#39;B_activated&#39;, &#39;B_mem&#39;, &#39;B_naive&#39;, &#39;B_plasma&#39;,
       &#39;B_preGC&#39;, &#39;DC_CCR7+&#39;, &#39;DC_cDC1&#39;, &#39;DC_cDC2&#39;, &#39;DC_pDC&#39;, &#39;Endo&#39;, &#39;FDC&#39;,
       &#39;ILC&#39;, &#39;Macrophages_M1&#39;, &#39;Macrophages_M2&#39;, &#39;Mast&#39;, &#39;Monocytes&#39;, &#39;NK&#39;,
       &#39;NKT&#39;, &#39;T_CD4+&#39;, &#39;T_CD4+_TfH&#39;, &#39;T_CD4+_TfH_GC&#39;, &#39;T_CD4+_naive&#39;,
       &#39;T_CD8+_CD161+&#39;, &#39;T_CD8+_cytotoxic&#39;, &#39;T_CD8+_naive&#39;, &#39;T_TIM3+&#39;, &#39;T_TfR&#39;,
       &#39;T_Treg&#39;, &#39;VSMC&#39;],
      dtype=&#39;object&#39;)
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># find centroids of each spot, scaled according to image size in pixels to enable overlay</span>
<span class="c1"># tissue_hires_scalef: A scaling factor that converts pixel positions in the original, full-resolution image</span>
<span class="c1"># to pixel positions in tissue_hires_image.png.</span>
<span class="n">scalef</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s2">&quot;spatial&quot;</span><span class="p">][</span><span class="s2">&quot;V1_Human_Lymph_Node&quot;</span><span class="p">][</span><span class="s2">&quot;scalefactors&quot;</span><span class="p">][</span><span class="s2">&quot;tissue_hires_scalef&quot;</span><span class="p">]</span>
<span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;X_centroid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s2">&quot;spatial&quot;</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">scalef</span>
<span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;Y_centroid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s2">&quot;spatial&quot;</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">scalef</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><br/><span></span><span class="k">with</span> <span class="n">mpl</span><span class="o">.</span><span class="n">rc_context</span><span class="p">({</span><span class="s1">&#39;axes.facecolor&#39;</span><span class="p">:</span>  <span class="s1">&#39;black&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;figure.figsize&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">4.5</span><span class="p">,</span> <span class="mi">5</span><span class="p">]}):</span>

    <span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">spatial</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;magma&#39;</span><span class="p">,</span>
                  <span class="c1"># show first 8 cell types</span>
                  <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;B_naive&#39;</span><span class="p">,</span>  <span class="s1">&#39;T_CD4+_naive&#39;</span><span class="p">,</span> <span class="s1">&#39;T_CD8+_naive&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;B_GC_DZ&#39;</span><span class="p">,</span> <span class="s1">&#39;B_GC_LZ&#39;</span><span class="p">,</span> <span class="s1">&#39;B_Cycling&#39;</span><span class="p">,</span> <span class="s1">&#39;T_CD4+_TfH_GC&#39;</span><span class="p">,</span> <span class="s1">&#39;FDC&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;B_preGC&#39;</span><span class="p">,],</span>
                  <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mf">1.3</span><span class="p">,</span>
                  <span class="n">img_key</span><span class="o">=</span><span class="s1">&#39;hires&#39;</span><span class="p">,</span>
                  <span class="c1"># limit color scale at 99.2% quantile of cell abundance</span>
                  <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="s1">&#39;p99.2&#39;</span>
                 <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_6_tutorial_visium_cell2location_8_0.png" src="../_images/tutorial_6_tutorial_visium_cell2location_8_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## identify celltype-dense spots.</span>
<span class="c1">## dense spots are defined here as spots of more than 90% quantile in cell type abundance</span>
<span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;mod&#39;</span><span class="p">][</span><span class="s1">&#39;factor_names&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_dense&quot;</span>
    <span class="p">]</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span>
        <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;mod&#39;</span><span class="p">][</span><span class="s1">&#39;factor_names&#39;</span><span class="p">]</span>
        <span class="p">]</span> <span class="o">&gt;</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span>
            <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;mod&#39;</span><span class="p">][</span><span class="s1">&#39;factor_names&#39;</span><span class="p">]</span>
            <span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.90</span><span class="p">)</span>

<span class="c1"># Here, we are interested in visualizing the spatial arrangement of germinal centers</span>
<span class="c1"># We located germinal centers based on germinal center specific B cell subtypes</span>
<span class="c1"># Which are identified by the Cell2location tutorial pipeline by Kleshchevnikov et al</span>
<span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;COI_community&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;B_Cycling_dense&quot;</span><span class="p">]</span> <span class="o">|</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;B_GC_LZ_dense&quot;</span><span class="p">]</span> <span class="o">|</span>
    <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;B_GC_DZ_dense&quot;</span><span class="p">]</span>
<span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plotting spots dense in B cell subtypes of interest</span>

<span class="n">adata1</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">adata1</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;B_Cycling_dense&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata1</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;B_Cycling_dense&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">adata1</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;B_GC_LZ_dense&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata1</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;B_GC_LZ_dense&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">adata1</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;B_GC_DZ_dense&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata1</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;B_GC_DZ_dense&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>


<span class="k">with</span> <span class="n">mpl</span><span class="o">.</span><span class="n">rc_context</span><span class="p">({</span><span class="s1">&#39;axes.facecolor&#39;</span><span class="p">:</span>  <span class="s1">&#39;black&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;figure.figsize&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">4.5</span><span class="p">,</span> <span class="mi">5</span><span class="p">]}):</span>

    <span class="n">sc</span><span class="o">.</span><span class="n">pl</span><span class="o">.</span><span class="n">spatial</span><span class="p">(</span><span class="n">adata1</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;magma&#39;</span><span class="p">,</span>
                  <span class="c1"># show first 8 cell types</span>
                  <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;B_Cycling_dense&#39;</span><span class="p">,</span> <span class="s1">&#39;B_GC_LZ_dense&#39;</span><span class="p">,</span> <span class="s1">&#39;B_GC_DZ_dense&#39;</span><span class="p">,</span> <span class="s2">&quot;COI_community&quot;</span><span class="p">],</span>
                  <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mf">1.3</span><span class="p">,</span>
                  <span class="n">img_key</span><span class="o">=</span><span class="s1">&#39;hires&#39;</span><span class="p">,</span>
                  <span class="c1"># limit color scale at 99.2% quantile of cell abundance</span>
                  <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="s1">&#39;p99.2&#39;</span>
                 <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_6_tutorial_visium_cell2location_10_0.png" src="../_images/tutorial_6_tutorial_visium_cell2location_10_0.png" />
</div>
</div>
</section>
<section id="getBoundary">
<h2>getBoundary<a class="headerlink" href="#getBoundary" title="Link to this heading"></a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">eps_estims</span> <span class="o">=</span> <span class="n">spc</span><span class="o">.</span><span class="n">spa</span><span class="o">.</span><span class="n">estimateInitialDistance</span><span class="p">(</span>
    <span class="n">adata</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;COI_community&quot;</span><span class="p">],</span> <span class="n">sampling_ratio</span><span class="o">=</span><span class="mf">0.2</span>
<span class="p">)</span>
<span class="n">eps_estims</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Computing distances...
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[33.36114384870609,
 93.11537188982376,
 321.85548625417425,
 1257.6925339706372,
 3761.444077919561]
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">boundary</span> <span class="o">=</span> <span class="n">spc</span><span class="o">.</span><span class="n">spa</span><span class="o">.</span><span class="n">getBoundary</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="s2">&quot;COI_community&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="n">eps_estims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
<span class="c1"># filter out small regions or holes based on the number of edges</span>
<span class="c1"># or the area of the region</span>
<span class="n">spot_diameter</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s2">&quot;spatial&quot;</span><span class="p">][</span><span class="s2">&quot;V1_Human_Lymph_Node&quot;</span><span class="p">][</span><span class="s2">&quot;scalefactors&quot;</span><span class="p">][</span><span class="s2">&quot;spot_diameter_fullres&quot;</span><span class="p">]</span>
<span class="n">spots_boundary</span> <span class="o">=</span> <span class="n">spc</span><span class="o">.</span><span class="n">spa</span><span class="o">.</span><span class="n">getExtendedBoundary</span><span class="p">(</span><span class="n">boundary</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">spot_diameter</span> <span class="o">*</span> <span class="n">scalef</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

<span class="n">boundary1</span> <span class="o">=</span> <span class="n">spc</span><span class="o">.</span><span class="n">spa</span><span class="o">.</span><span class="n">pruneSmallComponents</span><span class="p">(</span><span class="n">spots_boundary</span><span class="p">,</span> <span class="n">min_edges</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">min_area</span><span class="o">=</span><span class="mi">2000</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">[</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">]</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">spc</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">plotBoundary</span><span class="p">(</span><span class="n">boundary</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Centroids Boundary&quot;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">spc</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">plotBoundary</span><span class="p">(</span><span class="n">boundary1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Adjusted Spots Boundary&quot;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_6_tutorial_visium_cell2location_13_0.png" src="../_images/tutorial_6_tutorial_visium_cell2location_13_0.png" />
</div>
</div>
</section>
<section id="assignPointsToRegion">
<h2>assignPointsToRegion<a class="headerlink" href="#assignPointsToRegion" title="Link to this heading"></a></h2>
<p>Using one or more generated boundaries, cells can be assigned to different regions for downstream analysis.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">help</span><span class="p">(</span><span class="n">spc</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">assignPointsToRegions</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Help on function assignPointsToRegions in module spatialcells.spatial._assignPointsToRegions:

assignPointsToRegions(anndata, boundaries_list, region_names, assigncolumn=&#39;region&#39;, default=&#39;BG&#39;)
    Assign points to regions based on the boundaries. The region assignment is
    based on the order of the boundaries, so the innermost region should be the
    first element of boundaries_list.

    :param anndata: Anndata object
    :param boundaries_list: List of boundaries
    :param region_names: List of region names. The order and length should match boundaries_list
    :param assigncolumn: Column name for the region assignment
    :param default: Default region name for points that are not assigned to any region

</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">regions</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Germinal Center&quot;</span><span class="p">]</span>
<span class="n">boundaries_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">boundary1</span><span class="p">]</span>

<span class="n">spc</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">assignPointsToRegions</span><span class="p">(</span>
    <span class="n">adata</span><span class="p">,</span> <span class="n">boundaries_list</span><span class="p">,</span> <span class="n">regions</span><span class="p">,</span> <span class="n">assigncolumn</span><span class="o">=</span><span class="s2">&quot;region&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;Background&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
4012it [00:01, 2839.96it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Assigned points to region: Germinal Center
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Regions:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;region&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">categories</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Number of points in each region:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;region&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Regions:
Index([&#39;Germinal Center&#39;, &#39;Background&#39;], dtype=&#39;object&#39;)

Number of points in each region:
region
Background         3487
Germinal Center     548
Name: count, dtype: int64
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><br/><span></span><span class="c1"># fig, ax = plt.subplots(figsize=(8,10))</span>
<span class="c1"># plt.imshow(adata.uns[&quot;spatial&quot;][&quot;V1_Human_Lymph_Node&quot;][&quot;images&quot;][&quot;hires&quot;], alpha=1)</span>

<span class="c1"># plt.legend(loc=&quot;lower left&quot;, markerscale=5)</span>
<span class="c1"># plt.savefig(&#39;HnE.png&#39;, dpi=300)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[53]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">columns</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[53]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Index([&#39;in_tissue&#39;, &#39;array_row&#39;, &#39;array_col&#39;, &#39;sample&#39;, &#39;_indices&#39;,
       &#39;_scvi_batch&#39;, &#39;_scvi_labels&#39;, &#39;B_Cycling&#39;, &#39;B_GC_DZ&#39;, &#39;B_GC_LZ&#39;,
       &#39;B_GC_prePB&#39;, &#39;B_IFN&#39;, &#39;B_activated&#39;, &#39;B_mem&#39;, &#39;B_naive&#39;, &#39;B_plasma&#39;,
       &#39;B_preGC&#39;, &#39;DC_CCR7+&#39;, &#39;DC_cDC1&#39;, &#39;DC_cDC2&#39;, &#39;DC_pDC&#39;, &#39;Endo&#39;, &#39;FDC&#39;,
       &#39;ILC&#39;, &#39;Macrophages_M1&#39;, &#39;Macrophages_M2&#39;, &#39;Mast&#39;, &#39;Monocytes&#39;, &#39;NK&#39;,
       &#39;NKT&#39;, &#39;T_CD4+&#39;, &#39;T_CD4+_TfH&#39;, &#39;T_CD4+_TfH_GC&#39;, &#39;T_CD4+_naive&#39;,
       &#39;T_CD8+_CD161+&#39;, &#39;T_CD8+_cytotoxic&#39;, &#39;T_CD8+_naive&#39;, &#39;T_TIM3+&#39;, &#39;T_TfR&#39;,
       &#39;T_Treg&#39;, &#39;VSMC&#39;, &#39;X_centroid&#39;, &#39;Y_centroid&#39;, &#39;B_Cycling_dense&#39;,
       &#39;B_GC_DZ_dense&#39;, &#39;B_GC_LZ_dense&#39;, &#39;B_GC_prePB_dense&#39;, &#39;B_IFN_dense&#39;,
       &#39;B_activated_dense&#39;, &#39;B_mem_dense&#39;, &#39;B_naive_dense&#39;, &#39;B_plasma_dense&#39;,
       &#39;B_preGC_dense&#39;, &#39;DC_CCR7+_dense&#39;, &#39;DC_cDC1_dense&#39;, &#39;DC_cDC2_dense&#39;,
       &#39;DC_pDC_dense&#39;, &#39;Endo_dense&#39;, &#39;FDC_dense&#39;, &#39;ILC_dense&#39;,
       &#39;Macrophages_M1_dense&#39;, &#39;Macrophages_M2_dense&#39;, &#39;Mast_dense&#39;,
       &#39;Monocytes_dense&#39;, &#39;NK_dense&#39;, &#39;NKT_dense&#39;, &#39;T_CD4+_dense&#39;,
       &#39;T_CD4+_TfH_dense&#39;, &#39;T_CD4+_TfH_GC_dense&#39;, &#39;T_CD4+_naive_dense&#39;,
       &#39;T_CD8+_CD161+_dense&#39;, &#39;T_CD8+_cytotoxic_dense&#39;, &#39;T_CD8+_naive_dense&#39;,
       &#39;T_TIM3+_dense&#39;, &#39;T_TfR_dense&#39;, &#39;T_Treg_dense&#39;, &#39;VSMC_dense&#39;,
       &#39;COI_community&#39;, &#39;region&#39;],
      dtype=&#39;object&#39;)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[111]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># plotting spots dense in B cell subtypes of interest</span>

<span class="n">adata1</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">adata1</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;B_Cycling_dense&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata1</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;B_Cycling_dense&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">adata1</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;B_GC_LZ_dense&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata1</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;B_GC_LZ_dense&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="n">adata1</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;B_GC_DZ_dense&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">adata1</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;B_GC_DZ_dense&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="s2">&quot;yellow&quot;</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;tab:blue&quot;</span><span class="p">]</span>

<span class="n">point_size</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s2">&quot;spatial&quot;</span><span class="p">][</span><span class="s2">&quot;V1_Human_Lymph_Node&quot;</span><span class="p">][</span><span class="s2">&quot;images&quot;</span><span class="p">][</span><span class="s2">&quot;hires&quot;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1">#All</span>
<span class="n">tmp</span> <span class="o">=</span> <span class="n">adata</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">tmp</span><span class="o">.</span><span class="n">obs</span><span class="p">[[</span><span class="s2">&quot;X_centroid&quot;</span><span class="p">,</span> <span class="s2">&quot;Y_centroid&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()),</span>
           <span class="n">s</span><span class="o">=</span><span class="n">point_size</span><span class="p">,</span>
           <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
           <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
           <span class="p">)</span>

<span class="c1">#GC</span>
<span class="n">tmp</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">B_Cycling_dense</span><span class="o">|</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">B_GC_LZ_dense</span><span class="o">|</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">B_Cycling_dense</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">tmp</span><span class="o">.</span><span class="n">obs</span><span class="p">[[</span><span class="s2">&quot;X_centroid&quot;</span><span class="p">,</span> <span class="s2">&quot;Y_centroid&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()),</span>
           <span class="n">s</span><span class="o">=</span><span class="n">point_size</span><span class="p">,</span>
           <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
           <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
           <span class="p">)</span>
<span class="c1">#B native</span>
<span class="n">tmp</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">B_naive_dense</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">tmp</span><span class="o">.</span><span class="n">obs</span><span class="p">[[</span><span class="s2">&quot;X_centroid&quot;</span><span class="p">,</span> <span class="s2">&quot;Y_centroid&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()),</span>
           <span class="n">s</span><span class="o">=</span><span class="n">point_size</span><span class="p">,</span>
           <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
           <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
           <span class="p">)</span>
<span class="c1">#T native</span>
<span class="n">tmp</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;T_CD4+_naive_dense&quot;</span><span class="p">]</span><span class="o">|</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;T_CD8+_naive_dense&quot;</span><span class="p">]]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">*</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">tmp</span><span class="o">.</span><span class="n">obs</span><span class="p">[[</span><span class="s2">&quot;X_centroid&quot;</span><span class="p">,</span> <span class="s2">&quot;Y_centroid&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()),</span>
           <span class="n">s</span><span class="o">=</span><span class="n">point_size</span><span class="p">,</span>
           <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
           <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
           <span class="p">)</span>


<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;lower left&quot;</span><span class="p">,</span> <span class="n">markerscale</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="c1"># plt.savefig(&#39;cells.png&#39;, dpi=300)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
No artists with labels found to put in legend.  Note that artists whose label start with an underscore are ignored when legend() is called with no argument.
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_6_tutorial_visium_cell2location_20_1.png" src="../_images/tutorial_6_tutorial_visium_cell2location_20_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[110]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;tab:orange&quot;</span><span class="p">,</span> <span class="s2">&quot;tab:blue&quot;</span><span class="p">,</span> <span class="s2">&quot;tab:green&quot;</span><span class="p">,</span> <span class="s2">&quot;tab:grey&quot;</span><span class="p">,</span> <span class="s2">&quot;tab:red&quot;</span><span class="p">]</span>

<span class="n">point_size</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">spc</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">plotBoundary</span><span class="p">(</span>
    <span class="n">boundary1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Germinal Center Boundary&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span>
<span class="p">)</span>
<span class="c1"># get points in each region in order</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">region</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;region&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">categories</span><span class="p">):</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">region</span> <span class="o">==</span> <span class="n">region</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
        <span class="o">*</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">tmp</span><span class="o">.</span><span class="n">obs</span><span class="p">[[</span><span class="s2">&quot;X_centroid&quot;</span><span class="p">,</span> <span class="s2">&quot;Y_centroid&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()),</span>
        <span class="n">s</span><span class="o">=</span><span class="n">point_size</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="n">region</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s2">&quot;spatial&quot;</span><span class="p">][</span><span class="s2">&quot;V1_Human_Lymph_Node&quot;</span><span class="p">][</span><span class="s2">&quot;images&quot;</span><span class="p">][</span><span class="s2">&quot;hires&quot;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># plt.legend(loc=&quot;lower left&quot;, markerscale=5)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="c1"># plt.savefig(&#39;GC.png&#39;, dpi=300)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_6_tutorial_visium_cell2location_21_0.png" src="../_images/tutorial_6_tutorial_visium_cell2location_21_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[85]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## get overall boundary</span>
<span class="n">overall_boundary</span> <span class="o">=</span> <span class="n">spc</span><span class="o">.</span><span class="n">spa</span><span class="o">.</span><span class="n">getBoundary</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="s2">&quot;in_tissue&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="c1"># filter out small regions or holes based on the number of edges</span>
<span class="c1"># or the area of the region</span>
<span class="n">overall_boundary</span> <span class="o">=</span> <span class="n">spc</span><span class="o">.</span><span class="n">spa</span><span class="o">.</span><span class="n">getExtendedBoundary</span><span class="p">(</span><span class="n">overall_boundary</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">spot_diameter</span> <span class="o">*</span> <span class="n">scalef</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">overall_boundary1</span> <span class="o">=</span> <span class="n">spc</span><span class="o">.</span><span class="n">spa</span><span class="o">.</span><span class="n">pruneSmallComponents</span><span class="p">(</span><span class="n">overall_boundary</span><span class="p">,</span> <span class="n">min_edges</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">min_area</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>

<span class="c1"># fig, ax1 = plt.subplots(figsize=(5,6))</span>
<span class="c1"># spc.plt.plotBoundary(overall_boundary1, ax=ax1, color=&quot;r&quot;, label=&quot;Overall Boundary&quot;)</span>
<span class="c1"># ax1.legend()</span>
<span class="c1"># ax1.invert_yaxis()</span>
<span class="c1"># plt.show()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[174]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## Helper function to get cell type counts in each region, across several columns</span>
<span class="k">def</span> <span class="nf">getRegionCountsMean</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">regioncol</span><span class="p">,</span> <span class="n">columns</span><span class="p">):</span>
    <span class="n">all_counts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">regioncol</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">all_counts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">all_counts</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">getRegionCounts</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="n">regioncol</span><span class="p">,</span> <span class="n">columns</span><span class="p">):</span>
    <span class="n">all_counts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">regioncol</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">all_counts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">all_counts</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[176]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">raw_estim_mean</span> <span class="o">=</span> <span class="n">getRegionCountsMean</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="s2">&quot;region&quot;</span><span class="p">,</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;mod&#39;</span><span class="p">][</span><span class="s1">&#39;factor_names&#39;</span><span class="p">])</span>
<span class="n">percentage_dense</span> <span class="o">=</span> <span class="n">getRegionCounts</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="s2">&quot;region&quot;</span><span class="p">,</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;mod&#39;</span><span class="p">][</span><span class="s1">&#39;factor_names&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_dense&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[177]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;mod&#39;</span><span class="p">][</span><span class="s1">&#39;factor_names&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[177]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([&#39;B_Cycling&#39;, &#39;B_GC_DZ&#39;, &#39;B_GC_LZ&#39;, &#39;B_GC_prePB&#39;, &#39;B_IFN&#39;,
       &#39;B_activated&#39;, &#39;B_mem&#39;, &#39;B_naive&#39;, &#39;B_plasma&#39;, &#39;B_preGC&#39;,
       &#39;DC_CCR7+&#39;, &#39;DC_cDC1&#39;, &#39;DC_cDC2&#39;, &#39;DC_pDC&#39;, &#39;Endo&#39;, &#39;FDC&#39;, &#39;ILC&#39;,
       &#39;Macrophages_M1&#39;, &#39;Macrophages_M2&#39;, &#39;Mast&#39;, &#39;Monocytes&#39;, &#39;NK&#39;,
       &#39;NKT&#39;, &#39;T_CD4+&#39;, &#39;T_CD4+_TfH&#39;, &#39;T_CD4+_TfH_GC&#39;, &#39;T_CD4+_naive&#39;,
       &#39;T_CD8+_CD161+&#39;, &#39;T_CD8+_cytotoxic&#39;, &#39;T_CD8+_naive&#39;, &#39;T_TIM3+&#39;,
       &#39;T_TfR&#39;, &#39;T_Treg&#39;, &#39;VSMC&#39;], dtype=object)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[178]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># mean estimated cell type abundance in each spot for each region</span>
<span class="n">raw_estim_mean</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[178]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>B_Cycling</th>
      <th>B_GC_DZ</th>
      <th>B_GC_LZ</th>
      <th>B_GC_prePB</th>
      <th>B_IFN</th>
      <th>B_activated</th>
      <th>B_mem</th>
      <th>B_naive</th>
      <th>B_plasma</th>
      <th>B_preGC</th>
      <th>...</th>
      <th>T_CD4+_TfH</th>
      <th>T_CD4+_TfH_GC</th>
      <th>T_CD4+_naive</th>
      <th>T_CD8+_CD161+</th>
      <th>T_CD8+_cytotoxic</th>
      <th>T_CD8+_naive</th>
      <th>T_TIM3+</th>
      <th>T_TfR</th>
      <th>T_Treg</th>
      <th>VSMC</th>
    </tr>
    <tr>
      <th>region</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Germinal Center</th>
      <td>3.489793</td>
      <td>1.543892</td>
      <td>2.812592</td>
      <td>0.851064</td>
      <td>0.574457</td>
      <td>0.831627</td>
      <td>1.312993</td>
      <td>1.608901</td>
      <td>0.718583</td>
      <td>0.706312</td>
      <td>...</td>
      <td>0.249425</td>
      <td>1.695331</td>
      <td>0.686543</td>
      <td>0.198562</td>
      <td>0.316849</td>
      <td>0.391157</td>
      <td>0.945408</td>
      <td>0.515738</td>
      <td>0.293817</td>
      <td>0.403211</td>
    </tr>
    <tr>
      <th>Background</th>
      <td>0.665491</td>
      <td>0.384414</td>
      <td>0.509018</td>
      <td>0.240387</td>
      <td>0.718301</td>
      <td>1.187099</td>
      <td>1.957374</td>
      <td>1.868405</td>
      <td>1.379708</td>
      <td>1.140211</td>
      <td>...</td>
      <td>0.538775</td>
      <td>0.620881</td>
      <td>2.324264</td>
      <td>0.471576</td>
      <td>0.488169</td>
      <td>1.266793</td>
      <td>0.943437</td>
      <td>0.662367</td>
      <td>0.734309</td>
      <td>0.756567</td>
    </tr>
  </tbody>
</table>
<p>2 rows × 34 columns</p>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[179]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># percentage of spots in each region that are</span>
<span class="c1"># considered dense with each cell type</span>
<span class="n">percentage_dense</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[179]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>B_Cycling_dense</th>
      <th>B_GC_DZ_dense</th>
      <th>B_GC_LZ_dense</th>
      <th>B_GC_prePB_dense</th>
      <th>B_IFN_dense</th>
      <th>B_activated_dense</th>
      <th>B_mem_dense</th>
      <th>B_naive_dense</th>
      <th>B_plasma_dense</th>
      <th>B_preGC_dense</th>
      <th>...</th>
      <th>T_CD4+_TfH_dense</th>
      <th>T_CD4+_TfH_GC_dense</th>
      <th>T_CD4+_naive_dense</th>
      <th>T_CD8+_CD161+_dense</th>
      <th>T_CD8+_cytotoxic_dense</th>
      <th>T_CD8+_naive_dense</th>
      <th>T_TIM3+_dense</th>
      <th>T_TfR_dense</th>
      <th>T_Treg_dense</th>
      <th>VSMC_dense</th>
    </tr>
    <tr>
      <th>region</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Germinal Center</th>
      <td>345</td>
      <td>354</td>
      <td>365</td>
      <td>340</td>
      <td>59</td>
      <td>53</td>
      <td>36</td>
      <td>68</td>
      <td>1</td>
      <td>31</td>
      <td>...</td>
      <td>3</td>
      <td>269</td>
      <td>5</td>
      <td>1</td>
      <td>5</td>
      <td>4</td>
      <td>36</td>
      <td>5</td>
      <td>3</td>
      <td>5</td>
    </tr>
    <tr>
      <th>Background</th>
      <td>59</td>
      <td>50</td>
      <td>39</td>
      <td>64</td>
      <td>345</td>
      <td>351</td>
      <td>368</td>
      <td>336</td>
      <td>403</td>
      <td>373</td>
      <td>...</td>
      <td>401</td>
      <td>135</td>
      <td>399</td>
      <td>403</td>
      <td>399</td>
      <td>400</td>
      <td>368</td>
      <td>399</td>
      <td>401</td>
      <td>399</td>
    </tr>
  </tbody>
</table>
<p>2 rows × 34 columns</p>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[180]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## areas (in image pixels):</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Area of germinal centers:&quot;</span><span class="p">,</span> <span class="n">spc</span><span class="o">.</span><span class="n">msmt</span><span class="o">.</span><span class="n">getRegionArea</span><span class="p">(</span><span class="n">boundary1</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Area of tissue sample:&quot;</span><span class="p">,</span> <span class="n">spc</span><span class="o">.</span><span class="n">msmt</span><span class="o">.</span><span class="n">getRegionArea</span><span class="p">(</span><span class="n">overall_boundary1</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span>
    <span class="s2">&quot;Percentage area of germinal centers: &quot;</span>
    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="p">(</span><span class="n">spc</span><span class="o">.</span><span class="n">msmt</span><span class="o">.</span><span class="n">getRegionArea</span><span class="p">(</span><span class="n">boundary1</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">spc</span><span class="o">.</span><span class="n">msmt</span><span class="o">.</span><span class="n">getRegionArea</span><span class="p">(</span><span class="n">overall_boundary1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> %&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Area of germinal centers: 237973.08060695932
Area of tissue sample: 1907465.6849017586
Percentage area of germinal centers: 12.48 %
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[182]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">## cell type compositions</span>
<span class="c1"># for demo for now, only showing naive b cells</span>
<span class="nb">print</span><span class="p">(</span><span class="n">spc</span><span class="o">.</span><span class="n">msmt</span><span class="o">.</span><span class="n">getRegionComposition</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="s2">&quot;B_naive_dense&quot;</span><span class="p">,</span> <span class="n">regions</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Background&quot;</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">spc</span><span class="o">.</span><span class="n">msmt</span><span class="o">.</span><span class="n">getRegionComposition</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="s2">&quot;B_naive_dense&quot;</span><span class="p">,</span> <span class="n">regions</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Germinal Center&quot;</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
   B_naive_dense  cell_count  composition
0          False        3151     0.903642
1           True         336     0.096358
   B_naive_dense  cell_count  composition
0          False         480     0.875912
1           True          68     0.124088
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[183]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spc</span><span class="o">.</span><span class="n">msmt</span><span class="o">.</span><span class="n">getRegionComposition</span><span class="p">(</span>
    <span class="n">adata</span><span class="p">,</span> <span class="s2">&quot;FDC_dense&quot;</span><span class="p">,</span>
    <span class="n">regions</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Background&quot;</span><span class="p">],</span>
    <span class="n">regioncol</span><span class="o">=</span><span class="s2">&quot;region&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[183]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>FDC_dense</th>
      <th>cell_count</th>
      <th>composition</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>False</td>
      <td>3411</td>
      <td>0.978205</td>
    </tr>
    <tr>
      <th>1</th>
      <td>True</td>
      <td>76</td>
      <td>0.021795</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[184]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spc</span><span class="o">.</span><span class="n">msmt</span><span class="o">.</span><span class="n">getRegionComposition</span><span class="p">(</span>
    <span class="n">adata</span><span class="p">,</span> <span class="s2">&quot;FDC_dense&quot;</span><span class="p">,</span>
    <span class="n">regions</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Germinal Center&quot;</span><span class="p">],</span>
    <span class="n">regioncol</span><span class="o">=</span><span class="s2">&quot;region&quot;</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[184]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>FDC_dense</th>
      <th>cell_count</th>
      <th>composition</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>True</td>
      <td>328</td>
      <td>0.59854</td>
    </tr>
    <tr>
      <th>1</th>
      <td>False</td>
      <td>220</td>
      <td>0.40146</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[185]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">region</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[185]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
region
Background         3487
Germinal Center     548
Name: count, dtype: int64
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[186]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">boundary_component_list</span> <span class="o">=</span> <span class="n">spc</span><span class="o">.</span><span class="n">spa</span><span class="o">.</span><span class="n">getComponents</span><span class="p">(</span><span class="n">boundary1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Number of components:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">boundary_component_list</span><span class="p">))</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">region</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;region&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">categories</span><span class="p">):</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">region</span> <span class="o">==</span> <span class="n">region</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
        <span class="o">*</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">tmp</span><span class="o">.</span><span class="n">obs</span><span class="p">[[</span><span class="s2">&quot;X_centroid&quot;</span><span class="p">,</span> <span class="s2">&quot;Y_centroid&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()),</span>
        <span class="n">s</span><span class="o">=</span><span class="n">point_size</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="n">region</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="p">)</span>

<span class="n">spc</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">plotRegions</span><span class="p">(</span>
    <span class="n">boundary_component_list</span><span class="p">,</span>
    <span class="n">colors_list</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;g&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;m&quot;</span><span class="p">,</span> <span class="s2">&quot;k&quot;</span><span class="p">],</span>
    <span class="n">x_offset</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">y_offset</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s2">&quot;spatial&quot;</span><span class="p">][</span><span class="s2">&quot;V1_Human_Lymph_Node&quot;</span><span class="p">][</span><span class="s2">&quot;images&quot;</span><span class="p">][</span><span class="s2">&quot;hires&quot;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># ax.invert_yaxis()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Number of components: 33
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_6_tutorial_visium_cell2location_34_1.png" src="../_images/tutorial_6_tutorial_visium_cell2location_34_1.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[187]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span> <span class="s2">&quot;tab:blue&quot;</span><span class="p">,</span> <span class="s2">&quot;green&quot;</span><span class="p">,</span> <span class="s2">&quot;tab:blue&quot;</span><span class="p">]</span>

<span class="c1"># draw only the 3 germinal centers highlighted in the original paper</span>
<span class="n">selected_center_boundaries</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">boundary_component_list</span><span class="p">[</span><span class="mi">18</span><span class="p">],</span>
    <span class="n">boundary_component_list</span><span class="p">[</span><span class="mi">21</span><span class="p">],</span>
    <span class="n">boundary_component_list</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span>
<span class="p">]</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">region</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;region&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">categories</span><span class="p">):</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">region</span> <span class="o">==</span> <span class="n">region</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
        <span class="o">*</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">tmp</span><span class="o">.</span><span class="n">obs</span><span class="p">[[</span><span class="s2">&quot;X_centroid&quot;</span><span class="p">,</span> <span class="s2">&quot;Y_centroid&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()),</span>
        <span class="n">s</span><span class="o">=</span><span class="n">spot_diameter</span> <span class="o">*</span> <span class="n">scalef</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="n">region</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="p">)</span>

<span class="n">spc</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">plotRegions</span><span class="p">(</span>
    <span class="n">selected_center_boundaries</span><span class="p">,</span>
    <span class="n">colors_list</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;m&quot;</span><span class="p">,</span> <span class="s2">&quot;k&quot;</span><span class="p">],</span>
    <span class="n">x_offset</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">y_offset</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
    <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s2">&quot;spatial&quot;</span><span class="p">][</span><span class="s2">&quot;V1_Human_Lymph_Node&quot;</span><span class="p">][</span><span class="s2">&quot;images&quot;</span><span class="p">][</span><span class="s2">&quot;hires&quot;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">600</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">750</span><span class="p">,</span> <span class="mi">1150</span><span class="p">)</span>
<span class="c1"># ax.legend()</span>
<span class="c1"># ax.invert_yaxis()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_6_tutorial_visium_cell2location_35_0.png" src="../_images/tutorial_6_tutorial_visium_cell2location_35_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[189]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">shapely</span> <span class="kn">import</span> <span class="n">MultiPolygon</span>
<span class="n">example_centers_boundary</span> <span class="o">=</span> <span class="n">MultiPolygon</span><span class="p">([</span>
    <span class="n">boundary_component_list</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span><span class="o">.</span><span class="n">geoms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">boundary_component_list</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span><span class="o">.</span><span class="n">geoms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">boundary_component_list</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span><span class="o">.</span><span class="n">geoms</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
<span class="p">])</span>

<span class="n">extended_boundary</span> <span class="o">=</span> <span class="n">spc</span><span class="o">.</span><span class="n">spa</span><span class="o">.</span><span class="n">getExtendedBoundary</span><span class="p">(</span><span class="n">example_centers_boundary</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">spot_diameter</span> <span class="o">*</span> <span class="n">scalef</span> <span class="o">*</span> <span class="mf">1.7</span><span class="p">)</span>

<span class="n">extended_boundary2</span> <span class="o">=</span> <span class="n">spc</span><span class="o">.</span><span class="n">spa</span><span class="o">.</span><span class="n">getExtendedBoundary</span><span class="p">(</span><span class="n">extended_boundary</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">spot_diameter</span> <span class="o">*</span> <span class="n">scalef</span> <span class="o">*</span> <span class="mf">2.5</span><span class="p">)</span>


<span class="n">regions1</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Germinal Center&quot;</span><span class="p">,</span> <span class="s2">&quot;Extended Boundary&quot;</span><span class="p">,</span> <span class="s2">&quot;Extended Boundary 2&quot;</span><span class="p">]</span>
<span class="n">boundaries_list1</span> <span class="o">=</span> <span class="p">[</span><span class="n">example_centers_boundary</span><span class="p">,</span> <span class="n">extended_boundary</span><span class="p">,</span> <span class="n">extended_boundary2</span><span class="p">]</span>

<span class="n">spc</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">assignPointsToRegions</span><span class="p">(</span>
    <span class="n">adata</span><span class="p">,</span> <span class="n">boundaries_list1</span><span class="p">,</span> <span class="n">regions1</span><span class="p">,</span> <span class="n">assigncolumn</span><span class="o">=</span><span class="s2">&quot;selectRegion&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;Background&quot;</span>
<span class="p">)</span>


<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>

<span class="c1"># colors = [ &quot;tab:red&quot;,&quot;tab:blue&quot;, &quot;tab:blue&quot;, &quot;tab:blue&quot;]</span>
<span class="n">colors</span> <span class="o">=</span> <span class="p">[</span> <span class="s2">&quot;tab:red&quot;</span><span class="p">,</span><span class="s2">&quot;yellow&quot;</span><span class="p">,</span> <span class="s2">&quot;tab:green&quot;</span><span class="p">,</span> <span class="s2">&quot;tab:blue&quot;</span><span class="p">]</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">region</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;selectRegion&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">categories</span><span class="p">):</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="n">adata</span><span class="p">[</span><span class="n">adata</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s2">&quot;selectRegion&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">region</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
        <span class="o">*</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">tmp</span><span class="o">.</span><span class="n">obs</span><span class="p">[[</span><span class="s2">&quot;X_centroid&quot;</span><span class="p">,</span> <span class="s2">&quot;Y_centroid&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()),</span>
        <span class="n">s</span><span class="o">=</span><span class="n">spot_diameter</span> <span class="o">*</span> <span class="n">scalef</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="n">region</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="p">)</span>

<span class="n">spc</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">plotBoundary</span><span class="p">(</span>
    <span class="n">example_centers_boundary</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Germinal Center Boundary&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span>
<span class="p">)</span>
<span class="n">spc</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">plotBoundary</span><span class="p">(</span>
    <span class="n">extended_boundary</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;yellow&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Extended Boundary&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span>
<span class="p">)</span>
<span class="n">spc</span><span class="o">.</span><span class="n">plt</span><span class="o">.</span><span class="n">plotBoundary</span><span class="p">(</span>
    <span class="n">extended_boundary2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;g&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Extended Boundary 2&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span>
<span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
<span class="c1"># ax.legend()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s2">&quot;spatial&quot;</span><span class="p">][</span><span class="s2">&quot;V1_Human_Lymph_Node&quot;</span><span class="p">][</span><span class="s2">&quot;images&quot;</span><span class="p">][</span><span class="s2">&quot;hires&quot;</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">700</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">700</span><span class="p">,</span> <span class="mi">1200</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
136it [00:00, 13150.41it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Assigned points to region: Germinal Center
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
0it [00:00, ?it/s]114it [00:00, 14200.25it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Assigned points to region: Extended Boundary
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
160it [00:00, 18058.46it/s]
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Assigned points to region: Extended Boundary 2
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_6_tutorial_visium_cell2location_36_6.png" src="../_images/tutorial_6_tutorial_visium_cell2location_36_6.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[190]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">select_raw_estim_mean</span> <span class="o">=</span> <span class="n">getRegionCounts</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="s2">&quot;selectRegion&quot;</span><span class="p">,</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;mod&#39;</span><span class="p">][</span><span class="s1">&#39;factor_names&#39;</span><span class="p">])</span>
<span class="n">select_percentage_dense</span> <span class="o">=</span> <span class="n">getRegionCounts</span><span class="p">(</span><span class="n">adata</span><span class="p">,</span> <span class="s2">&quot;selectRegion&quot;</span><span class="p">,</span> <span class="n">adata</span><span class="o">.</span><span class="n">uns</span><span class="p">[</span><span class="s1">&#39;mod&#39;</span><span class="p">][</span><span class="s1">&#39;factor_names&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_dense&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[191]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">select_raw_estim_mean</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[191]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>B_Cycling</th>
      <th>B_GC_DZ</th>
      <th>B_GC_LZ</th>
      <th>B_GC_prePB</th>
      <th>B_IFN</th>
      <th>B_activated</th>
      <th>B_mem</th>
      <th>B_naive</th>
      <th>B_plasma</th>
      <th>B_preGC</th>
      <th>...</th>
      <th>T_CD4+_TfH</th>
      <th>T_CD4+_TfH_GC</th>
      <th>T_CD4+_naive</th>
      <th>T_CD8+_CD161+</th>
      <th>T_CD8+_cytotoxic</th>
      <th>T_CD8+_naive</th>
      <th>T_TIM3+</th>
      <th>T_TfR</th>
      <th>T_Treg</th>
      <th>VSMC</th>
    </tr>
    <tr>
      <th>selectRegion</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Germinal Center</th>
      <td>286.902964</td>
      <td>113.064673</td>
      <td>159.679207</td>
      <td>51.245447</td>
      <td>23.273735</td>
      <td>43.106062</td>
      <td>66.509449</td>
      <td>79.642546</td>
      <td>51.496140</td>
      <td>49.612274</td>
      <td>...</td>
      <td>17.269178</td>
      <td>111.767758</td>
      <td>52.921448</td>
      <td>12.987905</td>
      <td>18.707585</td>
      <td>29.394039</td>
      <td>61.963411</td>
      <td>37.720135</td>
      <td>21.032434</td>
      <td>25.728872</td>
    </tr>
    <tr>
      <th>Extended Boundary</th>
      <td>46.554121</td>
      <td>27.333019</td>
      <td>40.321693</td>
      <td>16.738548</td>
      <td>40.212077</td>
      <td>71.434094</td>
      <td>154.702069</td>
      <td>140.014732</td>
      <td>48.803659</td>
      <td>74.105153</td>
      <td>...</td>
      <td>26.607056</td>
      <td>49.270372</td>
      <td>125.810323</td>
      <td>21.887633</td>
      <td>22.388177</td>
      <td>66.206820</td>
      <td>52.500484</td>
      <td>41.552343</td>
      <td>41.759977</td>
      <td>34.385885</td>
    </tr>
    <tr>
      <th>Extended Boundary 2</th>
      <td>87.158340</td>
      <td>32.426226</td>
      <td>39.669068</td>
      <td>24.924477</td>
      <td>99.335584</td>
      <td>88.471167</td>
      <td>144.949332</td>
      <td>124.572365</td>
      <td>118.408322</td>
      <td>152.365655</td>
      <td>...</td>
      <td>66.516513</td>
      <td>61.398461</td>
      <td>371.280319</td>
      <td>56.007545</td>
      <td>48.345026</td>
      <td>195.484460</td>
      <td>117.901923</td>
      <td>91.279761</td>
      <td>101.936597</td>
      <td>74.761433</td>
    </tr>
    <tr>
      <th>Background</th>
      <td>3812.358491</td>
      <td>2013.681578</td>
      <td>3076.577213</td>
      <td>1211.702830</td>
      <td>2656.696160</td>
      <td>4392.135409</td>
      <td>7178.721235</td>
      <td>7052.576379</td>
      <td>4986.118130</td>
      <td>4086.893288</td>
      <td>...</td>
      <td>1905.000187</td>
      <td>2871.617469</td>
      <td>7930.921863</td>
      <td>1662.313938</td>
      <td>1786.438468</td>
      <td>4340.574597</td>
      <td>3575.483885</td>
      <td>2421.745253</td>
      <td>2556.818049</td>
      <td>2724.234355</td>
    </tr>
  </tbody>
</table>
<p>4 rows × 34 columns</p>
</div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[208]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">select_percentage_dense1</span> <span class="o">=</span> <span class="n">select_percentage_dense</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;Germinal Center&quot;</span><span class="p">,</span> <span class="s2">&quot;Extended Boundary&quot;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[209]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">select_percentage_dense1</span><span class="o">.</span><span class="n">columns</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[209]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Index([&#39;B_GC_DZ_dense&#39;, &#39;B_Cycling_dense&#39;, &#39;B_GC_prePB_dense&#39;, &#39;FDC_dense&#39;,
       &#39;B_GC_LZ_dense&#39;, &#39;T_CD4+_TfH_GC_dense&#39;, &#39;Macrophages_M1_dense&#39;,
       &#39;DC_cDC1_dense&#39;, &#39;B_naive_dense&#39;, &#39;B_activated_dense&#39;, &#39;B_preGC_dense&#39;,
       &#39;T_TIM3+_dense&#39;, &#39;B_mem_dense&#39;, &#39;B_IFN_dense&#39;, &#39;T_CD4+_dense&#39;,
       &#39;T_TfR_dense&#39;, &#39;T_CD4+_naive_dense&#39;, &#39;T_Treg_dense&#39;, &#39;NKT_dense&#39;,
       &#39;NK_dense&#39;, &#39;DC_CCR7+_dense&#39;, &#39;DC_cDC2_dense&#39;, &#39;DC_pDC_dense&#39;,
       &#39;Endo_dense&#39;, &#39;T_CD8+_naive_dense&#39;, &#39;T_CD8+_CD161+_dense&#39;, &#39;VSMC_dense&#39;,
       &#39;T_CD4+_TfH_dense&#39;, &#39;B_plasma_dense&#39;, &#39;ILC_dense&#39;, &#39;Monocytes_dense&#39;,
       &#39;T_CD8+_cytotoxic_dense&#39;, &#39;Macrophages_M2_dense&#39;, &#39;Mast_dense&#39;],
      dtype=&#39;object&#39;)
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[210]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">select_percentage_dense1</span> <span class="o">=</span><span class="n">select_percentage_dense</span><span class="p">[[</span>
    <span class="s1">&#39;B_GC_LZ_dense&#39;</span><span class="p">,</span> <span class="s1">&#39;B_GC_DZ_dense&#39;</span><span class="p">,</span> <span class="s1">&#39;B_Cycling_dense&#39;</span><span class="p">,</span> <span class="s1">&#39;B_GC_prePB_dense&#39;</span><span class="p">,</span>
    <span class="s1">&#39;FDC_dense&#39;</span><span class="p">,</span> <span class="s1">&#39;T_CD4+_TfH_GC_dense&#39;</span><span class="p">,</span>
    <span class="s1">&#39;B_naive_dense&#39;</span><span class="p">,</span> <span class="s1">&#39;B_mem_dense&#39;</span><span class="p">,</span> <span class="s1">&#39;B_activated_dense&#39;</span><span class="p">,</span> <span class="s1">&#39;B_IFN_dense&#39;</span><span class="p">,</span>
    <span class="s1">&#39;T_TfR_dense&#39;</span><span class="p">,</span> <span class="s1">&#39;T_CD4+_dense&#39;</span><span class="p">,</span> <span class="s1">&#39;T_CD4+_naive_dense&#39;</span><span class="p">,</span><span class="s1">&#39;DC_CCR7+_dense&#39;</span><span class="p">,</span>
    <span class="s1">&#39;T_Treg_dense&#39;</span><span class="p">,</span> <span class="s1">&#39;T_CD8+_naive_dense&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Monocytes_dense&#39;</span><span class="p">,</span> <span class="s1">&#39;Endo_dense&#39;</span><span class="p">,</span> <span class="s1">&#39;VSMC_dense&#39;</span><span class="p">,</span><span class="s1">&#39;Mast_dense&#39;</span><span class="p">,</span> <span class="s1">&#39;NKT_dense&#39;</span><span class="p">,</span> <span class="s1">&#39;B_plasma_dense&#39;</span>
<span class="p">]]</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[211]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># select_percentage_dense1.loc[&quot;Germinal Center&quot;] = select_percentage_dense1.loc[&quot;Germinal Center&quot;]/select_percentage_dense1.loc[&quot;Germinal Center&quot;].sum()</span>
<br/></pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[213]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">select_percentage_dense1</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;Germinal Center&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;bar&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
<span class="c1"># axs[0].set_title(&quot;Germinal Center&quot;, fontsize=12)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">55</span><span class="p">])</span>

<span class="n">select_percentage_dense1</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;Extended Boundary&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;bar&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">)</span>
<span class="c1"># axs[1].set_title(&quot;Extended Boundary Region&quot;)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">55</span><span class="p">])</span>

<span class="n">select_percentage_dense1</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;Extended Boundary 2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s2">&quot;bar&quot;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;g&quot;</span><span class="p">)</span>
<span class="c1"># axs[2].set_title(&quot;Extended Boundary 2 Region&quot;)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">55</span><span class="p">])</span>


<span class="c1"># fig.set_ylabel(&quot;Percentage of Dense Spots&quot;)</span>
<span class="c1"># select_percentage_dense1.loc[&quot;Background&quot;].plot(kind=&quot;bar&quot;, ax=axs[3], color=&quot;gray&quot;)</span>
<span class="c1"># axs[3].set_title(&quot;Background Region&quot;)</span>
<span class="c1"># axs[3].set_xlabel(&quot;Cell Type&quot;)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorial_6_tutorial_visium_cell2location_43_0.png" src="../_images/tutorial_6_tutorial_visium_cell2location_43_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[136]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># fig, axs = plt.subplots(4,1, figsize=(10, 8), sharex=True)</span>
<span class="c1"># select_percentage_dense.loc[&quot;Germinal Center&quot;].plot(kind=&quot;bar&quot;, ax=axs[0], color=&quot;r&quot;)</span>
<span class="c1"># select_percentage_dense.loc[&quot;Extended Boundary&quot;].plot(kind=&quot;bar&quot;, ax=axs[1], color=&quot;b&quot;)</span>
<span class="c1"># select_percentage_dense.loc[&quot;Extended Boundary 2&quot;].plot(kind=&quot;bar&quot;, ax=axs[2], color=&quot;g&quot;)</span>
<span class="c1"># select_percentage_dense.loc[&quot;Background&quot;].plot(kind=&quot;bar&quot;, ax=axs[3], color=&quot;k&quot;)</span>
<span class="c1"># axs[3].set_xlabel(&quot;Cell Type&quot;)</span>
<span class="c1"># plt.show()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="5_tutorial_import_export_omero.html" class="btn btn-neutral float-left" title="5: Loading and Saving Regions" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="7_tutorial_squidpy_joint_analysis.html" class="btn btn-neutral float-right" title="7: Working with Squidpy" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Dermatology Clinical Informatics Laboratory.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>